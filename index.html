<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes"><meta name="theme-color" content="#000000"><title>DMZ: MAP v4.1</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
<style>
    @import url('https://fonts.googleapis.com/css2?family=Share+Tech+Mono&display=swap');
    body{margin:0;padding:0;background:#000;font-family:'Share Tech Mono',monospace;overflow:hidden;color:#0f0;}
    .full-screen-ui{position:absolute;top:0;left:0;width:100%;height:100%;background:radial-gradient(circle at center,#0a150a 0%,#000 100%);z-index:2000;display:flex;flex-direction:column;justify-content:center;align-items:center;}
    h1{color:#fff;text-shadow:0 0 15px #0f0;font-size:36px;letter-spacing:4px;} .status-label{font-size:18px;font-weight:bold;padding:10px;border:1px solid #f00;color:#f00;width:80%;max-width:300px;text-align:center;margin-bottom:20px;background:rgba(255,0,0,0.1);clip-path:polygon(10px 0,100% 0,100% calc(100% - 10px),calc(100% - 10px) 100%,0 100%,0 10px);}
    .status-label.running{border-color:#0f0;color:#0f0;background:rgba(0,255,0,0.1);}
    .input-box{background:rgba(0,20,0,0.8);border:1px solid #0f0;color:#0f0;padding:15px;margin:8px;width:80%;max-width:300px;text-align:center;font-size:16px;font-family:'Share Tech Mono';clip-path:polygon(8px 0,100% 0,100% calc(100% - 8px),calc(100% - 8px) 100%,0 100%,0 8px);outline:none;}
    .btn-deploy{background:linear-gradient(135deg,#004400 0%,#001100 100%);color:#0f0;border:1px solid #0f0;padding:15px;font-size:18px;font-family:'Share Tech Mono';cursor:pointer;margin-top:15px;width:80%;max-width:300px;clip-path:polygon(15px 0,100% 0,100% calc(100% - 15px),calc(100% - 15px) 100%,0 100%,0 15px);}
    #map{height:100vh;width:100vw;z-index:1;background:#111;position:absolute;top:0;left:0;}
    .base-marker-container{position:relative;width:30px;height:30px;display:flex;justify-content:center;align-items:center;}
    .base-circle{background:rgba(255,255,0,0.9);border:2px solid #000;border-radius:50%;width:20px;height:20px;display:flex;justify-content:center;align-items:center;color:#000;font-weight:bold;font-size:10px;box-shadow:0 0 8px #ff0;}
    .base-name{position:absolute;top:24px;width:120px;text-align:center;color:#ff0;font-size:10px;font-weight:bold;pointer-events:none;}
    .exfil-circle{background:rgba(0,255,255,0.9);border:2px solid #000;border-radius:50%;width:24px;height:24px;display:flex;justify-content:center;align-items:center;font-size:12px;box-shadow:0 0 8px #0ff;}
    #hud-top-container{position:absolute;top:0;left:0;width:100%;z-index:1000;display:flex;flex-direction:column;pointer-events:none;}
    #global-timers-bar{background:rgba(0,0,0,0.85);color:#fff;font-size:12px;padding:5px 10px;display:flex;justify-content:space-between;border-bottom:1px solid #555;}
    #obj-banner{width:100%;background:rgba(0,15,0,0.85);border-bottom:2px solid #0f0;padding:8px 0;color:#0f0;font-weight:bold;font-size:14px;text-align:center;}
    #hud-bottom{position:absolute;bottom:30px;left:50%;transform:translateX(-50%);z-index:1000;display:flex;gap:20px;pointer-events:auto;}
    .action-btn{background:rgba(0,20,0,0.85);border:2px solid #0f0;color:#0f0;width:60px;height:60px;display:flex;justify-content:center;align-items:center;font-size:24px;cursor:pointer;clip-path:polygon(15px 0,100% 0,100% calc(100% - 15px),calc(100% - 15px) 100%,0 100%,0 15px);}
    .game-modal{position:absolute;top:0;left:0;width:100%;height:100%;background:rgba(0,15,0,0.95);backdrop-filter:blur(8px);z-index:3000;display:none;flex-direction:column;justify-content:center;align-items:center;}
    .modal-title{color:#0ff;font-size:26px;font-weight:bold;margin-bottom:15px;}
    #tactical-alert-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.9);z-index:9999;display:none;justify-content:center;align-items:center;}
    #tactical-alert-box{background:#0a0505;border:2px solid #f00;padding:25px;width:85%;max-width:320px;text-align:center;clip-path:polygon(15px 0,100% 0,100% calc(100% - 15px),calc(100% - 15px) 100%,0 100%,0 15px);}
    .tactical-btn{background:#300;border:1px solid #f00;color:#fff;padding:10px;font-family:'Share Tech Mono';cursor:pointer;flex:1;} .tactical-btn-ok{background:#030;border-color:#0f0;color:#0f0;}
</style>
</head>
<body>

<div id="tactical-alert-overlay"><div id="tactical-alert-box"><h3 id="tactical-alert-title" style="color:#f00;border-bottom:1px solid #f00;">INFO</h3><div id="tactical-alert-msg" style="color:#fff;margin:20px 0;font-size:14px;white-space:pre-line;"></div><div id="tactical-alert-btns" style="display:flex;gap:10px;"></div></div></div>

<div id="login-screen" class="full-screen-ui">
    <h1>DMZ DEPLOY</h1><div class="version-tag">PLAYER v4.1 STABILE</div>
    <div id="status-label" class="status-label">CONNESSIONE...</div>
    <input type="text" id="p-name" class="input-box" placeholder="NOME OPERATORE">
    <select id="p-team" class="input-box"><option value="ALPHA">SQUADRA ALPHA</option><option value="BRAVO">SQUADRA BRAVO</option></select>
    <button id="btn-deploy" class="btn-deploy" onclick="deploy()" style="display:none;">DISPIEGAMENTO</button>
</div>

<div id="scanner-modal" class="game-modal"><div class="modal-title">SCANSIONE</div><div id="qr-reader" style="width:100%;max-width:350px;"></div><div style="display:flex;width:90%;max-width:350px;gap:5px;margin-top:15px;"><input type="text" id="manual-code-input" class="input-box" style="width:70%;" placeholder="ES: C1"><button class="btn-deploy" style="width:30%;margin:0;" onclick="processScannedCode()">VAI</button></div><button class="btn-deploy" style="background:transparent;border-color:#f00;color:#fff;" onclick="closeScanner()">ANNULLA</button></div>

<div id="map"></div>

<div id="hud-top-container" style="display:none;">
    <div id="global-timers-bar"><span>‚è± <span id="time-left" class="timer-text">--:--</span></span><span>üíÄ OP: <span id="players-alive" class="timer-text">--</span></span></div>
    <div id="obj-banner">OBIETTIVO: SOPRAVVIVENZA</div>
</div>
<div id="hud-bottom" style="display:none;"><div class="action-btn" onclick="centerMap()">üìç</div><div class="action-btn" style="border-color:#0ff;color:#0ff;" onclick="openScanner()">üì∑</div></div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
    import { getDatabase, ref, update, set, onValue, onDisconnect } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";
    const app = initializeApp({ apiKey: "AIzaSyCggNlC5bOdGVBzUsfX8wO4ygkNzNcFFm0", authDomain: "softair-dmz.firebaseapp.com", databaseURL: "https://softair-dmz-default-rtdb.firebaseio.com", projectId: "softair-dmz" });
    const db = getDatabase(app);

    window.speakTactical = function(testo) { if ('speechSynthesis' in window) { window.speechSynthesis.cancel(); let msg = new SpeechSynthesisUtterance(testo); msg.lang = 'it-IT'; msg.rate = 1.15; window.speechSynthesis.speak(msg); } };
    window.tacticalAlert = function(msg, title = "INFO", isGood = false) { document.getElementById('tactical-alert-title').innerText = title; document.getElementById('tactical-alert-title').style.color = isGood ? "#0f0" : "#f00"; document.getElementById('tactical-alert-box').style.borderColor = isGood ? "#0f0" : "#f00"; document.getElementById('tactical-alert-msg').innerText = msg; document.getElementById('tactical-alert-btns').innerHTML = `<button class="tactical-btn ${isGood?'tactical-btn-ok':''}" onclick="document.getElementById('tactical-alert-overlay').style.display='none'">RICEVUTO</button>`; document.getElementById('tactical-alert-overlay').style.display = 'flex'; };

    let activeBases=[], currentExfilPoints=[];
    let myId="", myName="", myTeam="", myStatus="active", map, myMarker=null, markers={}; 
    let isDeployed=false, globalSettings={status:'lobby'}, playersDataCache={}, isGameOver=false;
    window.globalExfils={}; window.exfilAudioStates={};

    function formatTime(ms) { if(ms<=0) return "00:00"; let t=Math.floor(ms/1000); return `${Math.floor(t/60).toString().padStart(2,'0')}:${(t%60).toString().padStart(2,'0')}`; }

    onValue(ref(db, 'dmz_settings'), (snap) => {
        globalSettings = snap.val() || {};
        let sl = document.getElementById('status-label'); let bd = document.getElementById('btn-deploy');
        if (globalSettings.status === 'running') {
            if(sl) { sl.innerText = "üü¢ PARTITA IN CORSO"; sl.className = "status-label running"; } if(bd) bd.style.display = "block";
        } else {
            if(sl) { sl.innerText = "üî¥ IN ATTESA DEL MASTER"; sl.className = "status-label"; } if(bd) bd.style.display = "none";
            if (isDeployed) { tacticalAlert("La partita √® terminata. Disconnessione...", "FINE PARTITA", false); setTimeout(()=>window.location.reload(), 4000); }
        }
    });

    onValue(ref(db, 'dmz_exfils'), (snap) => { window.globalExfils = snap.val() || {}; });
    onValue(ref(db, 'dmz_players'), (snap) => { if(isDeployed){ playersDataCache = snap.val() || {}; renderMarkers(); }});

    window.deploy = function() {
        let n = document.getElementById('p-name').value.trim().toUpperCase(); if(!n) return tacticalAlert("Inserisci il Nome!"); 
        myName = n; myTeam = document.getElementById('p-team').value; myId = "OP_" + myName.replace(/[^A-Z0-9]/g, '');
        document.getElementById('login-screen').style.display = 'none'; document.getElementById('hud-top-container').style.display = 'flex'; document.getElementById('hud-bottom').style.display = 'flex';
        isDeployed = true; update(ref(db, 'dmz_players/' + myId), { name: myName, team: myTeam, status: 'active', lat: 45.6795, lng: 9.8975 });
        currentExfilPoints = globalSettings.exfil_config?.points || [{ id: "C1", lat: 45.6800, lng: 9.8966, label: "EXFIL C1" }];
        initMap(); startGPS(); speakTactical("Dispiegamento autorizzato.");
    };

    function initMap() {
        map = L.map('map', { zoomControl: false }).setView([45.6795, 9.8975], 17); L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(map);
        currentExfilPoints.forEach(ex => { L.marker([ex.lat, ex.lng], {icon: L.divIcon({ className:'exfil-icon-static', html:`<div class="base-marker-container"><div class="exfil-circle" style="background:#555;">H</div></div>`, iconSize:[30,30] }) }).addTo(map); });
    }

    function startGPS() {
        navigator.geolocation.watchPosition((pos) => {
            if(myStatus === 'exfil') return;
            const lat = pos.coords.latitude, lng = pos.coords.longitude;
            update(ref(db, 'dmz_players/' + myId), { lat: lat, lng: lng, status: myStatus });
            if (!myMarker) { myMarker = L.marker([lat, lng], {icon: L.divIcon({ html: `<div style="width:20px;height:20px;background:cyan;border:3px solid white;border-radius:50%;box-shadow:0 0 15px cyan;"></div>`, iconSize: [20, 20] }) }).addTo(map); map.setView([lat, lng], 18); } else { myMarker.setLatLng([lat, lng]); }
        }, ()=>{}, { enableHighAccuracy: true });
    }

    function renderMarkers() {
        if(!isDeployed || !map) return; let now = Date.now();
        Object.keys(markers).forEach(k => { if (!k.startsWith('EX_')) { map.removeLayer(markers[k]); delete markers[k]; } });
        Object.keys(playersDataCache).forEach(k => {
            if (k === myId) return; const p = playersDataCache[k]; if (!p || p.status === 'exfil' || p.lat === undefined) return;
            if (p.team === myTeam || p.status === "dead") {
                let c = (p.team===myTeam)?"#0f0":"#555"; let ic = L.divIcon({ html:`<div style="width:15px;height:15px;background:${c};border:2px solid #000;border-radius:50%;"></div>`, iconSize:[15,15] });
                if(!markers[k]) markers[k] = L.marker([p.lat, p.lng], {icon:ic}).addTo(map); else markers[k].setLatLng([p.lat, p.lng]);
            }
        });
        Object.keys(window.globalExfils || {}).forEach(k => {
            let ex = window.globalExfils[k];
            if (now <= ex.departAt) {
                let isLanded = (now >= ex.arriveAt); let color = isLanded ? "#0f0" : "#f00"; let status = isLanded ? "ATTERRATO (30s)" : "IN ARRIVO";
                let ic = L.divIcon({ html: `<div class="base-marker-container"><div class="exfil-circle" style="border-color:${color};color:${color};box-shadow:0 0 15px ${color};">üöÅ</div><div style="color:${color};font-size:10px;font-weight:bold;margin-top:25px;width:100px;margin-left:-35px;text-align:center;">${k}<br>${status}</div></div>`, iconSize: [30, 30] });
                if(!markers[`EX_${k}`]) markers[`EX_${k}`] = L.marker([ex.lat, ex.lng], {icon:ic}).addTo(map); else { markers[`EX_${k}`].setIcon(ic); markers[`EX_${k}`].setLatLng([ex.lat, ex.lng]); }
            } else { if(markers[`EX_${k}`]) { map.removeLayer(markers[`EX_${k}`]); delete markers[`EX_${k}`]; } }
        });
    }

    let html5QrCode = null;
    window.openScanner = function() { 
        if(myStatus !== 'active') return tacticalAlert("Sei a terra o eliminato!"); document.getElementById('scanner-modal').style.display = 'flex'; document.getElementById('manual-code-input').value = ""; 
        setTimeout(() => { if(window.html5QrCode) return; window.html5QrCode = new Html5Qrcode("qr-reader"); window.html5QrCode.start({facingMode:"environment"},{fps:10,qrbox:250},(txt)=>{ window.html5QrCode.stop().then(()=>{window.html5QrCode=null;document.getElementById('manual-code-input').value=txt;window.processScannedCode();});}).catch(()=>{}); }, 200);
    };
    window.closeScanner = function() { document.getElementById('scanner-modal').style.display = 'none'; if(window.html5QrCode) { window.html5QrCode.stop().then(()=>{window.html5QrCode=null;}); } };

    window.processScannedCode = function() {
        let code = document.getElementById('manual-code-input').value.trim().toUpperCase(); closeScanner();
        
        // LOGICA ELICOTTERO DOPPIA SCANSIONE V4.1
        if (code.startsWith('C') || code.startsWith('E')) {
            if (!globalSettings.exfil_config || !globalSettings.exfil_config.enabled) return tacticalAlert("Elicottero disabilitato.");
            let ex = window.globalExfils && window.globalExfils[code]; let now = Date.now();

            if (!ex || now > ex.departAt) {
                // 1¬∞ SCANSIONE: CHIAMA ELICOTTERO
                let waitMs = (globalSettings.exfil_config.waitTime || 2) * 60000;
                let point = currentExfilPoints.find(p => p.id === code); if(!point) return tacticalAlert("Punto non valido.");
                update(ref(db, `dmz_exfils/${code}`), { calledAt: now, arriveAt: now + waitMs, departAt: now + waitMs + 30000, callerTeam: myTeam, lat: point.lat, lng: point.lng });
            } 
            else if (now < ex.arriveAt) {
                tacticalAlert(`L'elicottero √® in volo.\nAttendi l'atterraggio.`, "IN AVVICINAMENTO");
            } 
            else if (now >= ex.arriveAt && now <= ex.departAt) {
                // 2¬∞ SCANSIONE: ESTRAZIONE
                doExfil();
            }
        }
    };

    function doExfil() {
        if(myStatus === 'exfil') return; 
        myStatus = 'exfil'; update(ref(db, 'dmz_players/' + myId), { status: 'exfil' });
        speakTactical("Estrazione completata. Ottimo lavoro.");
        
        // SCHERMATA NERA E BLOCCO TOTALE V4.1
        document.getElementById('hud-top-container').style.display = 'none'; document.getElementById('hud-bottom').style.display = 'none'; document.getElementById('map').style.display = 'none';
        document.body.innerHTML += `<div style="position:absolute;top:0;left:0;width:100%;height:100%;background:#000;z-index:9999;display:flex;flex-direction:column;justify-content:center;align-items:center;color:#0f0;font-family:monospace;text-align:center;"><h2>MISSIONE COMPIUTA</h2><br>Estrazione Riuscita.<br><br>Disconnessione in corso...</div>`;
        
        setTimeout(() => { window.location.reload(); }, 6000);
    }

    setInterval(() => {
        if(!isDeployed || !map || myStatus === 'exfil') return; let now = Date.now(); renderMarkers();

        // TIMER GIOCO E AUTO-CHIUSURA FASE 1
        if (globalSettings.gameEndTime && !isGameOver) {
            let timeLeftMs = globalSettings.gameEndTime - now;
            if (timeLeftMs <= 0) {
                isGameOver = true; document.getElementById('time-left').innerText = "00:00"; document.getElementById('time-left').style.color = "#f00";
                if(myStatus === 'active') { speakTactical("Tempo scaduto. Missione fallita."); tacticalAlert("TEMPO SCADUTO (KIA).", "GAME OVER"); myStatus='dead'; update(ref(db, 'dmz_players/' + myId), { status: 'dead' }); }
            } else { document.getElementById('time-left').innerText = formatTime(timeLeftMs); }
        }

        let aliveCount = 0; let totalPlayers = Object.keys(playersDataCache).length;
        Object.keys(playersDataCache).forEach(k => { if (playersDataCache[k].status !== 'exfil' && playersDataCache[k].status !== 'dead') aliveCount++; });
        document.getElementById('players-alive').innerText = aliveCount;
        if(aliveCount === 0 && totalPlayers > 0 && !isGameOver && globalSettings.status === 'running') { isGameOver = true; update(ref(db, 'dmz_settings'), { status: 'lobby' }); }

        // AUDIO ELICOTTERO E BANNER V4.1
        let myExfilCode = null; let myExfilData = null;
        Object.keys(window.globalExfils || {}).forEach(k => {
            let ex = window.globalExfils[k]; if (!window.exfilAudioStates[k]) window.exfilAudioStates[k] = { called: false, arrived: false, departed: false }; let st = window.exfilAudioStates[k];
            if (!st.called && now < ex.arriveAt) { st.called = true; if(ex.callerTeam !== "SYSTEM") { speakTactical("Elicottero in avvicinamento."); tacticalAlert(`Elicottero chiamato a ${k}.`, "RADAR"); } }
            if (!st.arrived && now >= ex.arriveAt && now <= ex.departAt) { st.arrived = true; speakTactical("Elicottero arrivato. 30 secondi alla partenza."); if (ex.callerTeam === myTeam) tacticalAlert(`ATTERRATO!\nHai 30s per scansionare ${k}.`, "IMBARCO", true); }
            if (!st.departed && now > ex.departAt) { st.departed = true; if (ex.callerTeam === myTeam) speakTactical("Elicottero ripartito."); }
            if ((ex.callerTeam === myTeam || ex.callerTeam === "SYSTEM") && now <= ex.departAt) { myExfilCode = k; myExfilData = ex; }
        });

        let osText = "OBIETTIVO: SOPRAVVIVENZA"; let osColor = "#0f0";
        if (myExfilData) {
            if (now < myExfilData.arriveAt) { let r = Math.ceil((myExfilData.arriveAt - now) / 1000); osText = `üöÅ ARRIVO ${myExfilCode}: ${r}s`; osColor = "#ff0"; } 
            else if (now <= myExfilData.departAt) { let r = Math.ceil((myExfilData.departAt - now) / 1000); osText = `üöÅ IMBARCO ${myExfilCode}: ${r}s`; osColor = "#0f0"; }
        }
        if (myStatus === 'dead') { osText = `üíÄ ELIMINATO`; osColor = "#f00"; }
        let ob = document.getElementById('obj-banner'); if(ob) { ob.innerText = osText; ob.style.color = osColor; ob.style.borderColor = osColor; }
    }, 1000);

    window.centerMap = function() { if(myMarker) map.setView(myMarker.getLatLng(), 18); };
    let wakeLock = null; async function keepScreenAwake() { try { if ('wakeLock' in navigator) { wakeLock = await navigator.wakeLock.request('screen'); } } catch (err) {} }
    document.addEventListener('visibilitychange', () => { if (wakeLock !== null && document.visibilityState === 'visible') keepScreenAwake(); }); document.addEventListener('click', keepScreenAwake, { once: true });
</script>
</body>
</html>
